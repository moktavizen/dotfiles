#!/bin/bash
# audioctl.sh

export LC_ALL=C

case "$1" in
  --speaker)
    wp_id="@DEFAULT_AUDIO_SINK@"
    type="Speaker"
    is_speaker=true
    ;;
  --microphone)
    wp_id="@DEFAULT_AUDIO_SOURCE@"
    type="Microphone"
    is_speaker=false
    ;;
  *)
    exit 1
    ;;
esac

if [[ "$2" == "toggle" ]]; then
  wpctl set-mute "$wp_id" toggle
else
  wpctl set-volume -l 1.50 "$wp_id" "$2"
fi

read -ra wp_output <<<"$(wpctl get-volume "$wp_id")"

vol_float="${wp_output[1]}"
vol_str="${vol_float/./}"
vol_pct=$((10#$vol_str))

if [[ "${wp_output[2]}" ]]; then
  icon="audio-volume-muted"
  text_suffix=" â€” Muted"
else
  icon="audio-volume-high"
  text_suffix=""

  if [[ "$is_speaker" == true && "$vol_pct" -gt 0 ]]; then
    flock -n "/run/user/$UID/audioctl.lock" \
      pw-play /usr/share/sounds/freedesktop/stereo/audio-volume-change.oga &>/dev/null &
  fi
fi

exec dunstify \
  -a audioctl \
  -i "$icon" \
  -h "string:x-dunst-stack-tag:${type,,}" \
  -h "int:value:$vol_pct" \
  "${type}: ${vol_pct}%${text_suffix}"

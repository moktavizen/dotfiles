#!/bin/bash
#
# Install software that I use on Arch Linux Hyprland
#
# - usage       : run this script in $HOME directory with sudo

set -euo pipefail

configure_pacman() {
  sed -i '/^\[options\]/a\Color' /etc/pacman.conf
  sed -i '/^\[options\]/a\ILoveCandy' /etc/pacman.conf
}

install_paru() {
  pacman -S --needed git base-devel --noconfirm
  sudo -u "$SUDO_USER" git clone https://aur.archlinux.org/paru-bin.git
  cd paru-bin
  sudo -u "$SUDO_USER" makepkg -si --noconfirm
  cd ..
  sudo -u "$SUDO_USER" rm -rf paru-bin
}

install_packages() {
  sudo -u "$SUDO_USER" paru -S --needed --noconfirm \
    stow \
    greetd \
    hyprland \
    hyprpaper \
    hyprpicker \
    qt5-wayland \
    qt6-wayland \
    polkit-gnome \
    xdg-desktop-portal-hyprland \
    inter-font \
    ttf-jetbrains-mono-nerd \
    adobe-source-serif-fonts \
    noto-fonts \
    noto-fonts-cjk \
    noto-fonts-emoji \
    noto-fonts-extra \
    dunst \
    waybar \
    wofi \
    tlp \
    pavucontrol \
    bluetui \
    grimblast \
    foot \
    foot-terminfo \
    zsh \
    zsh-autosuggestions \
    zsh-syntax-highlighting \
    fastfetch \
    tmux \
    neovim \
    tree-sitter-cli \
    lazygit \
    ripgrep \
    eza \
    bat \
    fd \
    dust \
    btop \
    nautilus \
    mpv \
    shotwell \
    zen-browser-bin \
    gnome-boxes
}

configure_boot() {
  local loader_conf="/boot/loader/loader.conf"

  sed -i '/^timeout/s/^/#/' "$loader_conf"

  local entries_conf

  for entries_conf in /boot/loader/entries/*_linux.conf; do
    if [ -f "$entries_conf" ]; then
      grep -q "^initrd.*/intel-ucode.img" "$entries_conf" \
        || sed -i '/^linux/a initrd  /boot/intel-ucode.img' "$entries_conf"

      sed -i '/^options / {/ quiet/! s/$/ quiet/}' "$entries_conf"
    fi
  done
}

configure_greeter() {
  tee -a /etc/greetd/config.toml <<EOF

[initial_session]
command = "Hyprland"
user = "$SUDO_USER"
EOF
}

configure_systemctl() {
  systemctl enable greetd.service
  systemctl enable bluetooth.service
  systemctl enable tlp.service
  systemctl enable paccache.timer
}

configure_dotfiles() {
  sudo -u "$SUDO_USER" git clone https://github.com/moktavizen/dotfiles
  cd dotfiles

  sudo -u "$SUDO_USER" stow \
    hypr \
    fontconfig \
    wallpapers \
    waybar \
    wofi \
    dunst \
    easyeffects \
    foot \
    zsh \
    fastfetch \
    tmux \
    bin \
    nvim \
    mpv
}

confgiure_home() {
  mkdir -p "$HOME/Desktop"
  mkdir -p "$HOME/Documents"
  mkdir -p "$HOME/Downloads"

  ln -s /media/Pictures "$HOME/Books"
  ln -s /media/Music "$HOME/Music"
  ln -s /media/Pictures "$HOME/Pictures"
  ln -s /media/Pictures "$HOME/Videos"
}

main() {
  if [ -z "${SUDO_USER:-}" ]; then
    echo "Error: Run this script with sudo!"
    exit 1
  fi

  configure_pacman
  install_paru
  install_packages
  configure_boot
  configure_greeter
  configure_systemctl
  configure_dotfiles
  configure_home

  sudo -u "$SUDO_USER" echo "Post Installation process complete!"
}

main "$@"
